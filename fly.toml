# Fly.io config for the backend API (FastAPI/Uvicorn)
# Deploy with: flyctl deploy -c fly.toml

app = "booka-api-charel"  # globally unique app name
primary_region = "jnb"  # Johannesburg (fallback to ams if not available)

[build]
  dockerfile = "backend/Dockerfile.fly"
  # Limit build context to backend/ to avoid uploading the entire repo (speeds up deploys)
  context = "backend"

[env]
  PORT = "8000"
  UVICORN_WORKERS = "4"
  # Keep DB connections modest when running behind PgBouncer/Cloud SQL
  DB_POOL_SIZE = "6"
  DB_MAX_OVERFLOW = "6"
  DB_POOL_TIMEOUT = "5"
  # Persist DB and uploads on the mounted volume
  SQLALCHEMY_DATABASE_URL = "sqlite:////data/booking.db"
  ATTACHMENTS_DIR = "/data/attachments"
  UPLOADS_DIR = "/data/uploads"
  # Cloud SQL via Workload Identity Federation + Auth Proxy
  # The entrypoint will start the Cloud SQL Auth Proxy using these.
  # IMPORTANT: Set DB_URL/SQLALCHEMY_DATABASE_URL secrets to the proxy DSN
  # (e.g., postgresql+psycopg2://appuser:<ENCODED_PASS>@127.0.0.1:5432/appdb)
  CLOUDSQL_INSTANCE = "genial-venture-474508-v3:africa-south1:booking-app-dev"
  WIF_AUDIENCE = "//iam.googleapis.com/projects/227610941821/locations/global/workloadIdentityPools/flyio-apps-pool/providers/flyio-provider"
  # Redis is optional. Do NOT set a localhost default in production.
  # If you use Redis (Upstash/Fly Redis), set these as secrets instead:
  #   flyctl secrets set REDIS_URL=redis://... WEBSOCKET_REDIS_URL=redis://... -a booka-api-charel
  # Leaving them unset disables cache warmers and SSE pub/sub.

[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 3
  processes = ["app"]
  # WebSockets are supported automatically over the same service

  [http_service.concurrency]
    # Count HTTP requests only (keep long WS/SSE sockets from burning slots)
    type = "requests"
    soft_limit = 80
    hard_limit = 100

  # Health check against FastAPI health endpoint
[[http_service.checks]]
  grace_period = "120s"
  interval = "10s"
  method = "get"
  timeout = "20s"
  path = "/healthz"

# Persist SQLite DB and attachments on a volume named "data".
[mounts]
  source = "data"
  destination = "/data"

[deploy]
  # Run migrations using the same entrypoint so the Cloud SQL proxy is started first.
  # APP_CMD tells the entrypoint to run Alembic instead of the web server.
  release_command = "bash -lc 'APP_CMD=\"alembic upgrade head\" /app/entrypoint.sh'"
